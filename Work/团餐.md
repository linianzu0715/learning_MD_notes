# 目录

[1、团餐一期](#团餐一期)

[2、团餐二期](#团餐二期)

[3、团餐三期](#团餐三期)

[4、遇到的问题](#遇到的问题)

# <span id="团餐一期">1、团餐一期</span>

### 背景：

对账能力：团餐业务形态，决定了团餐业务有比较多的跨期预约单、取消单。目前团餐与客户的对账，运营线下人工跑数，存在因跨期完单、退款单场景导致的账单金额不准、反复对账等问题，也因此影响了开票效率、回款效率。更重要的是，会损害企业客户的体验，进而损害对平台的信任度。

发票能力：发票发票管理线上化，作为深圳发票项目的前置项目，是深圳发票项目最终落地必不可少的重要环节之一。深圳发票项目，是团餐业务非常重要的、甚至是战略级的项目，能够极大提高团餐业务的售卖力。

### 功能点：

1、团餐企业入驻，入驻时候除了需要设置企业的基础信息之外还需要设置：

* 企业发票模式：美团开票（海淀，深圳开票主体），商家开票（随餐开票，月度开票），不开发票。
* 打款方式：预充值和美团垫资。

2、团餐订单下单的时候，订单中记录下单的团餐企业，订单中企业支付的金额，个人支付的金额。计费和分账。入团餐企业账单，周期结算之后产生发票信息。

3、根据发票信息对团餐企业开发票。



# <span id="团餐二期">2、团餐二期</span>

### 背景：

支持医药闪购：团餐一期只支持下外卖订单，本次新增闪购和医药订单的支持。

从支付获取数据：修复一期存在的一个问题：一期获取订单中的企业支付金额和个人支付金额，但是实际订单中下单时候的支付方式和实际支付方式可能会不同。因此更改为从支付侧获取订单最终的企业支付金额和个人支付金额。

### 功能点：

1、支持团餐下单医药，闪购订单。

2、订单支付金额更改为从支付侧获取。



# <span id="团餐三期">3、团餐三期</span>

### 背景：

一期和二期我们只记录了企业支付的餐费，在账单中没有记录企业支付的服务费。实际上是需要向企业收取服务费的，但是如果是个人支付就不会收取服务费。因此总共的平衡关系是：用户总支付 = 企业支付餐费 + 企业支付服务费 + 个人支付餐费。在三期中，结算将处理服务费的部分进行计费分账，最终汇总进入账单并且开取服务费发票。

### 功能点：

1、计费时从支付获取订单中企业支付的服务费金额。

2、对服务费金额进行分账并且汇总进入账单。

3、对账单中的服务费进行进行开票。

4、新增调整项调整企业支付服务费能力：开服务费发票（美团开票），开服务费发票（商家开票），开服务费发票（不开发票）。





# <span id="遇到的问题">4、遇到的问题</span>

### 1、团餐一期时参数和枚举值多，导致组合出来场景多，验证麻烦。

**问题：**

团餐一期中的订单参数：

* 发票模式：美团海淀开票，美团深圳开票，商家开票，不开发票。
* 支付模式：预付，美团垫资
* 下单方式：外卖模式，渠道模式，V1模式，V2模式（特定的商家入驻）
* 订单流程：订单下单-订单完成前部分退-订单完成-订单完成后部分退-订单取消

枚举值组合下来总共有几十种场景需要覆盖。场景数目多，全覆盖的工作量大。

**解决方式：**

1、改造下单工具，模拟收到的订单参数，只需要手动更改订单中的参数就可以下单对应场景的订单。简化了数据构造的过程。

2、配合自动化框架，将覆盖的场景的验证转为自动化执行，避免在多场景情况下手动验证可能会产生遗漏。